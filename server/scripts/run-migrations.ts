import { MongoClient, ObjectId } from 'mongodb';
import { hash } from 'bcryptjs';

type Migration = {
  name: string;
  up: (db: any) => Promise<void>;
};

const migrations: Migration[] = [
  {
    name: 'create-raw-materials',
    up: async (db) => {
      const materials = db.collection('materials');
      
      const defaultMaterials = [
        {
          name: 'Fa',
          type: 'raw',
          rarity: 'common',
          description: 'Alapvet≈ë nyersanyag √©p√≠tkez√©shez √©s k√©zm≈±vess√©ghez.',
          icon: 'wood.png',
          baseValue: 5,
          weight: 1.0,
          stackSize: 100,
          gatherSkill: 'fav√°g√°s',
          gatherTime: 5, // m√°sodperc
          createdAt: new Date(),
          updatedAt: new Date()
        },
        {
          name: 'K≈ë',
          type: 'raw',
          rarity: 'common',
          description: 'Kem√©ny k≈ë, √©p√≠tkez√©shez √©s eszk√∂z√∂k k√©sz√≠t√©s√©hez.',
          icon: 'stone.png',
          baseValue: 8,
          weight: 2.5,
          stackSize: 50,
          gatherSkill: 'b√°ny√°szat',
          gatherTime: 8,
          createdAt: new Date(),
          updatedAt: new Date()
        },
        {
          name: 'Vas√©rc',
          type: 'ore',
          rarity: 'uncommon',
          description: 'Nyers vas√©rc, feldolgoz√°s ut√°n haszn√°lhat√≥ fegyverek √©s p√°nc√©lok k√©sz√≠t√©s√©hez.',
          icon: 'iron_ore.png',
          baseValue: 20,
          weight: 3.0,
          stackSize: 25,
          gatherSkill: 'b√°ny√°szat',
          gatherLevel: 10,
          gatherTime: 12,
          smeltResult: 'vasr√∫d',
          smeltAmount: 1,
          smeltTime: 30,
          createdAt: new Date(),
          updatedAt: new Date()
        },
        {
          name: 'Gy√≥gyf≈±',
          type: 'herb',
          rarity: 'common',
          description: 'Ritka gy√≥gyf≈±, gy√≥gyitalok k√©sz√≠t√©s√©hez haszn√°lhat√≥.',
          icon: 'herb.png',
          baseValue: 15,
          weight: 0.2,
          stackSize: 50,
          gatherSkill: 'gy≈±jt√∂get√©s',
          gatherTime: 6,
          createdAt: new Date(),
          updatedAt: new Date()
        },
        {
          name: 'B≈ër',
          type: 'leather',
          rarity: 'common',
          description: 'Feldolgozott √°llatb≈ër, p√°nc√©lok √©s felszerel√©sek k√©sz√≠t√©s√©hez.',
          icon: 'leather.png',
          baseValue: 12,
          weight: 1.5,
          stackSize: 40,
          craftMaterial: true,
          processedFrom: 'nyers_b≈ër',
          processTime: 10,
          createdAt: new Date(),
          updatedAt: new Date()
        }
      ];

      for (const material of defaultMaterials) {
        const exists = await materials.findOne({ name: material.name as string });
        if (!exists) {
          await materials.insertOne(material);
          console.log(`‚úÖ L√©trehozva nyersanyag: ${material.name}`);
        } else {
          console.log(`‚ÑπÔ∏è A(z) ${material.name} nyersanyag m√°r l√©tezik`);
        }
      }
    }
  },
  {
    name: 'create-admin-user',
    up: async (db) => {
      const users = db.collection('users');
      const adminExists = await users.findOne({ username: 'admin' });
      
      if (!adminExists) {
        const hashedPassword = await hash('admin123', 10);
        await users.insertOne({
          username: 'admin',
          email: 'admin@rpg-game.com',
          password: hashedPassword,
          role: 'admin',
          isVerified: true,
          lastLogin: new Date(),
          settings: { 
            theme: 'dark',
            language: 'hu',
            notifications: { email: true, push: true }
          },
          createdAt: new Date(),
          updatedAt: new Date(),
          __v: 0
        });
        console.log('‚úÖ Created admin user');
      } else {
        console.log('‚ÑπÔ∏è Admin user already exists');
      }
    }
  },
  {
    name: 'create-default-items',
    up: async (db) => {
      const items = db.collection('items');
      const defaultItems = [
        {
          name: 'Bronz Kard',
          type: 'weapon',
          rarity: 'common',
          damage: 10,
          value: 50,
          weight: 2.5,
          description: 'Egyszer≈± bronz kard kezd≈ë harcosoknak.',
          icon: 'bronze_sword.png',
          createdAt: new Date(),
          updatedAt: new Date()
        },
        {
          name: 'B≈ërp√°nc√©l',
          type: 'armor',
          rarity: 'common',
          defense: 5,
          value: 30,
          weight: 5,
          description: 'Egyszer≈± b≈ërp√°nc√©l v√©delmet ny√∫jt a harcosoknak.',
          icon: 'leather_armor.png',
          createdAt: new Date(),
          updatedAt: new Date()
        },
        {
          name: 'Gy√≥gy√≠t√≥ B√°jital',
          type: 'potion',
          rarity: 'uncommon',
          effect: 'heal',
          value: 25,
          weight: 0.5,
          description: 'Gy√≥gy√≠tja a s√©r√ºl√©seket √©s visszat√∂lt egy kis √©leter≈ët.',
          icon: 'health_potion.png',
          createdAt: new Date(),
          updatedAt: new Date()
        },
        {
          name: '≈êsi √ârem',
          type: 'currency',
          rarity: 'rare',
          value: 100,
          weight: 0.1,
          description: '≈êsi √©rm√©k, amelyeket a j√°t√©k k√ºl√∂nleges √°rucikkeinek megv√°s√°rl√°s√°ra lehet haszn√°lni.',
          icon: 'ancient_coin.png',
          createdAt: new Date(),
          updatedAt: new Date()
        }
      ];

      for (const item of defaultItems) {
        const exists = await items.findOne({ name: item.name });
        if (!exists) {
          await items.insertOne(item);
          console.log(`‚úÖ Created item: ${item.name}`);
        } else {
          console.log(`‚ÑπÔ∏è Item already exists: ${item.name}`);
        }
      }
    }
  },
  {
    name: 'create-default-skills',
    up: async (db) => {
      const skills = db.collection('skills');
      const defaultSkills = [
        {
          name: 'Er≈ëteljes Csap√°s',
          type: 'active',
          description: 'Egy er≈ës, kivitelezett csap√°s az ellenf√©l ellen.',
          damage: 15,
          manaCost: 10,
          cooldown: 5,
          level: 1,
          icon: 'power_strike.png',
          createdAt: new Date(),
          updatedAt: new Date()
        },
        {
          name: 'Els≈ëseg√©ly',
          type: 'active',
          description: 'Gy√≥gy√≠tsd meg magad vagy sz√∂vets√©gesedet egy kis mennyis√©g≈± √©leter≈ëvel.',
          heal: 10,
          manaCost: 8,
          cooldown: 8,
          level: 1,
          icon: 'first_aid.png',
          createdAt: new Date(),
          updatedAt: new Date()
        }
      ];

      for (const skill of defaultSkills) {
        const exists = await skills.findOne({ name: skill.name });
        if (!exists) {
          await skills.insertOne(skill);
          console.log(`‚úÖ Created skill: ${skill.name}`);
        } else {
          console.log(`‚ÑπÔ∏è Skill already exists: ${skill.name}`);
        }
      }
    }
  },
  {
    name: 'create-default-quests',
    up: async (db) => {
      const quests = db.collection('quests');
      const items = db.collection('items');
      const skills = db.collection('skills');
      
      // Get required IDs
      const bronzeSword = await items.findOne({ name: 'Bronz Kard' });
      const firstAidSkill = await skills.findOne({ name: 'Els≈ëseg√©ly' });
      
      if (!bronzeSword || !firstAidSkill) {
        console.log('‚ö†Ô∏è Required items/skills not found for quest creation');
        return;
      }
      
      const defaultQuests = [
        {
          title: 'Els≈ë L√©p√©sek',
          description: 'Ismerkedj meg a j√°t√©kkal √©s szerezz tapasztalati pontokat!',
          objectives: [
            { description: 'J√°rj k√∂rbe a faluban', completed: false },
            { description: 'Besz√©lj a falusi f≈ëemberrel', completed: false },
            { description: 'Gy≈±jts √∂ssze 5 darab gy√≥gyf√ºvet', completed: false, target: 5, current: 0 }
          ],
          rewards: {
            experience: 100,
            items: [
              { itemId: new ObjectId(bronzeSword._id), quantity: 1 }
            ],
            skills: [
              { skillId: new ObjectId(firstAidSkill._id) }
            ]
          },
          minLevel: 1,
          maxLevel: 5,
          repeatable: false,
          npcGiver: 'Falusi F≈ëember',
          npcTurnIn: 'Falusi F≈ëember',
          createdAt: new Date(),
          updatedAt: new Date()
        }
      ];

      for (const quest of defaultQuests) {
        const exists = await quests.findOne({ title: quest.title });
        if (!exists) {
          await quests.insertOne(quest);
          console.log(`‚úÖ Created quest: ${quest.title}`);
        } else {
          console.log(`‚ÑπÔ∏è Quest already exists: ${quest.title}`);
        }
      }
    }
  }
];

async function runMigrations() {
  console.log('=== STARTING MIGRATIONS ===');
  
  const MONGODB_URI = process.env.MONGO_URI || 'mongodb://localhost:27017/rpg-game';
  console.log(`Connecting to: ${MONGODB_URI}`);
  
  const client = new MongoClient(MONGODB_URI, {
    serverSelectionTimeoutMS: 5000,
    socketTimeoutMS: 10000,
  });
  
  try {
    // Connect to MongoDB
    console.log('Connecting to database...');
    await client.connect();
    console.log('‚úÖ Connected to MongoDB');
    
    const db = client.db();
    console.log(`Using database: ${db.databaseName}`);
    
    // Create migrations collection if it doesn't exist
    const migrationsCollection = db.collection('migrations');
    await migrationsCollection.createIndex({ name: 1 }, { unique: true });
    
    // Run each migration
    for (const migration of migrations) {
      console.log(`\nüîÑ Running migration: ${migration.name}`);
      
      // Check if migration was already run
      const existingMigration = await migrationsCollection.findOne({ name: migration.name });
      
      if (existingMigration) {
        console.log(`‚ÑπÔ∏è Migration already applied: ${migration.name}`);
        continue;
      }
      
      try {
        // Run migration
        await migration.up(db);
        
        // Record migration
        await migrationsCollection.insertOne({
          name: migration.name,
          appliedAt: new Date(),
          status: 'completed'
        });
        
        console.log(`‚úÖ Successfully applied migration: ${migration.name}`);
      } catch (error: any) {
        const errorMessage = error instanceof Error ? error.message : String(error);
        console.error(`‚ùå Error applying migration ${migration.name}:`, errorMessage);
        
        // Record failed migration
        await migrationsCollection.updateOne(
          { name: migration.name },
          {
            $set: {
              appliedAt: new Date(),
              status: 'failed',
              error: errorMessage
            }
          },
          { upsert: true }
        );
        
        throw error; // Stop on error
      }
    }
    
    console.log('\n=== ALL MIGRATIONS COMPLETED SUCCESSFULLY ===');
    return true;
  } catch (error) {
    console.error('\n‚ùå MIGRATION FAILED:', error);
    return false;
  } finally {
    await client.close();
    console.log('Connection closed');
  }
}

// Run migrations
runMigrations()
  .then(success => {
    process.exit(success ? 0 : 1);
  })
  .catch(err => {
    console.error('Unhandled error:', err);
    process.exit(1);
  });
